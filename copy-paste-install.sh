#!/bin/bash

echo "ðŸš€ Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ Ð‘ÐžÐ¢ÐžÐ’ ÐÐ Ð¡Ð•Ð Ð’Ð•Ð Ð•"
echo "============================"

# Ð¨Ð°Ð³ 1: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
apt update -y
apt upgrade -y

# Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
apt install -y curl wget git nano htop screen unzip

# Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js..."
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs
fi

# Ð¨Ð°Ð³ 4: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PM2
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PM2..."
if ! command -v pm2 &> /dev/null; then
    npm install -g pm2
fi

# Ð¨Ð°Ð³ 5: ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²
echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²..."
pm2 stop all 2>/dev/null
pm2 delete all 2>/dev/null
pkill -f node 2>/dev/null
sleep 3

# Ð¨Ð°Ð³ 6: ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
cd /root
rm -rf 12G
git clone https://github.com/Sargiton/12G.git
cd 12G

# Ð¨Ð°Ð³ 7: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°..."
rm -rf node_modules package-lock.json LynxSession/* BackupSession/* qr.png tmp/*
cp package-clean.json package.json
npm install --force
npm install baileys@latest --save --force

# Ð¨Ð°Ð³ 8: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¿Ð¾Ðº
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¿Ð¾Ðº..."
mkdir -p LynxSession BackupSession tmp logs

# Ð¨Ð°Ð³ 9: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²
echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²..."
find . -name "*.js" -type f -exec sed -i 's/@whiskeysockets\/baileys/baileys/g' {} \;

# Ð¨Ð°Ð³ 10: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ°
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ°..."
node -c index.js
node -c telegram-bot.cjs

# Ð¨Ð°Ð³ 11: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ PM2
echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ PM2..."
cat > ecosystem-final.config.cjs << 'EOF'
module.exports = {
  apps: [
    {
      name: 'whatsapp-bot',
      script: 'index.js',
      cwd: '/root/12G',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '200M',
      env: { NODE_ENV: 'production', NODE_OPTIONS: '--max-old-space-size=512' },
      error_file: './logs/whatsapp-error-0.log',
      out_file: './logs/whatsapp-out-0.log',
      log_file: './logs/whatsapp-combined-0.log',
      time: true
    },
    {
      name: 'telegram-bot',
      script: 'telegram-bot.cjs',
      cwd: '/root/12G',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '100M',
      env: { NODE_ENV: 'production' },
      error_file: './logs/telegram-error-1.log',
      out_file: './logs/telegram-out-1.log',
      log_file: './logs/telegram-combined-1.log',
      time: true
    }
  ]
};
EOF

# Ð¨Ð°Ð³ 12: Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð¾Ð²
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð¾Ð²..."
pm2 start ecosystem-final.config.cjs

# Ð¨Ð°Ð³ 13: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°
echo "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°..."
pm2 startup
pm2 save

# Ð¨Ð°Ð³ 14: Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
echo ""
echo "ðŸŽ‰ Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ!"
echo "======================"
echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð±Ð¾Ñ‚Ð¾Ð²:"
pm2 list
echo ""
echo "ðŸ“± ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ /qr Ð² Telegram Ð±Ð¾Ñ‚Ð°"
echo "ðŸ“‹ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "  pm2 list          - ÑÑ‚Ð°Ñ‚ÑƒÑ Ð±Ð¾Ñ‚Ð¾Ð²"
echo "  pm2 logs          - Ð»Ð¾Ð³Ð¸ Ð±Ð¾Ñ‚Ð¾Ð²"
echo "  pm2 monit         - Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³"
echo "  pm2 restart all   - Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… Ð±Ð¾Ñ‚Ð¾Ð²"
echo "  pm2 stop all      - Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð²ÑÐµÑ… Ð±Ð¾Ñ‚Ð¾Ð²"
