#!/bin/bash

echo "üßπ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –û–ß–ò–°–¢–ö–ê QR –ö–≠–®–ê"
echo "=================================="

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pm2 stop all
pm2 delete all
pkill -f node
pkill -f pm2

# –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
sleep 5

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd /root/12G

# –û—á–∏—â–∞–µ–º –í–°–ï –∫—ç—à–∏ –∏ —Å–µ—Å—Å–∏–∏
echo "üßπ –û—á–∏—â–∞–µ–º –≤—Å–µ –∫—ç—à–∏ –∏ —Å–µ—Å—Å–∏–∏..."
rm -rf LynxSession/*
rm -rf BackupSession/*
rm -f qr.png
rm -f qr.jpg
rm -rf tmp/*
rm -rf storage/data/cache/*
rm -rf logs/*

# –û—á–∏—â–∞–µ–º –∫—ç—à Node.js
echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à Node.js..."
npm cache clean --force

# –£–¥–∞–ª—è–µ–º node_modules –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
echo "üì¶ –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
rm -rf node_modules
rm -f package-lock.json
npm install --force

# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –ø–∞–ø–∫–∏
echo "üìÅ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –ø–∞–ø–∫–∏..."
mkdir -p LynxSession
mkdir -p BackupSession
mkdir -p tmp
mkdir -p logs

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π QR –∫–æ–¥
echo "üì± –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π QR –∫–æ–¥..."
if [ -f "simple-qr.js" ]; then
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR –≤ —Ñ–æ–Ω–µ
    node simple-qr.js &
    QR_PID=$!
    
    # –ñ–¥–µ–º 20 —Å–µ–∫—É–Ω–¥
    echo "‚è≥ –ñ–¥–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞..."
    sleep 20
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
    kill $QR_PID 2>/dev/null
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if [ -f "qr.png" ]; then
        echo "‚úÖ –ù–æ–≤—ã–π QR –∫–æ–¥ —Å–æ–∑–¥–∞–Ω!"
        ls -la qr.png
    else
        echo "‚ùå QR –∫–æ–¥ –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è"
    fi
else
    echo "‚ùå –§–∞–π–ª simple-qr.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç—ã –∑–∞–Ω–æ–≤–æ
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç—ã –∑–∞–Ω–æ–≤–æ..."
if [ -f "ecosystem-simple.config.cjs" ]; then
    pm2 start ecosystem-simple.config.cjs
else
    pm2 start index.js --name "whatsapp-bot"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
sleep 5
pm2 list

echo ""
echo "üéâ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üì± –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–≤—ã–π QR –∫–æ–¥ –≤ Telegram"
