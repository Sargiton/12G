#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞–º—è—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å 1 –ì–ë RAM
echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞..."

while true; do
    echo "=========================================="
    echo "$(date)"
    echo "=========================================="
    
    # –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–º—è—Ç–∏
    echo "üíæ –û–±—â–∞—è –ø–∞–º—è—Ç—å:"
    free -h
    
    # –ü—Ä–æ—Ü–µ—Å—Å—ã PM2
    echo "ü§ñ –ü—Ä–æ—Ü–µ—Å—Å—ã PM2:"
    pm2 list
    
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
    echo "üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏:"
    ps aux --sort=-%mem | head -10
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ swap
    echo "üíø Swap:"
    swapon --show
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–∞
    echo "üíΩ –î–∏—Å–∫:"
    df -h
    
    # –ï—Å–ª–∏ –ø–∞–º—è—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∑–∫–∞—è, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç—ã
    MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}')
    if [ "$MEMORY_USAGE" -gt 90 ]; then
        echo "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –ü–ê–ú–Ø–¢–ò: ${MEMORY_USAGE}%"
        echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–æ–≤..."
        pm2 restart all
        sleep 30
    fi
    
    echo "=========================================="
    echo ""
    
    # –ñ–¥–µ–º 5 –º–∏–Ω—É—Ç
    sleep 300
done
